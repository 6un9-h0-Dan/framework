<?php
/**
 * Spiral Framework.
 *
 * @license   MIT
 * @author    Anton Titov (Wolfy-J)
 * @copyright Â©2009-2015
 */
namespace Spiral\Components\Session\Http;

use Psr\Http\Message\ServerRequestInterface;
use Spiral\Components\Http\Cookies\Cookie;
use Spiral\Components\Http\HttpDispatcher;
use Spiral\Components\Http\MiddlewareInterface;
use Spiral\Components\Http\Response;
use Spiral\Components\Session\SessionStore;
use Spiral\Core\Container;

class SessionStarter implements MiddlewareInterface
{
    /**
     * Cookie to store session ID in.
     */
    const COOKIE = 'session';

    /**
     * Http dispatcher instance fetched from context.
     *
     * @var HttpDispatcher
     */
    protected $httpDispatcher = null;

    /**
     * Session store instance.
     *
     * @var SessionStore
     */
    protected $store = null;

    /**
     * Manually set session store instance.
     *
     * @param SessionStore $store
     */
    public function setStore(SessionStore $store)
    {
        $this->store = $store;
    }

    /**
     * Get session store instance.
     *
     * @return SessionStore
     */
    public function getStore()
    {
        if (!empty($this->store))
        {
            return $this->store;
        }

        return $this->store = SessionStore::make();
    }

    /**
     * Handle request generate response. Middleware used to alter incoming Request and/or Response
     * generated by inner pipeline layers.
     *
     * @param ServerRequestInterface $request Server request instance.
     * @param \Closure               $next    Next middleware/target.
     * @param object|null            $context Pipeline context, can be HttpDispatcher, Route or module.
     * @return Response
     */
    public function __invoke(ServerRequestInterface $request, \Closure $next = null, $context = null)
    {
        $this->httpDispatcher = $context;

        $cookies = $request->getCookieParams();
        if (isset($cookies[self::COOKIE]))
        {
            //Mounting ID retrieved from cookies
            $this->getStore()->setID($cookies[self::COOKIE]);
        }

        $response = $next();

        if (empty($this->store) && is_object(Container::getBinding('session')))
        {
            //Store were started by itself
            $this->setStore(Container::get('session'));
        }

        if (!empty($this->store) && ($this->store->isStarted() || $this->store->isDestroyed()))
        {
            return $this->commitSession($this->store, $response, $cookies);
        }

        return $response;
    }

    /**
     * Mount session id or remove session cookie.
     *
     * @param SessionStore $store
     * @param Response     $response
     * @param array        $cookies
     * @return Response
     */
    protected function commitSession(SessionStore $store, Response $response, array $cookies)
    {
        $store->isStarted() && $store->commit();

        if (!isset($cookies[self::COOKIE]) || $cookies[self::COOKIE] != $store->getID())
        {
            if ($response instanceof Response)
            {
                return $response->withAddedHeader('Set-Cookie', new Cookie(
                    self::COOKIE,
                    $store->getID(),
                    $store->getConfig()['lifetime'],
                    $this->httpDispatcher->getConfig()['basePath'],
                    $this->httpDispatcher->cookieDomain()
                ));
            }
        }

        return $response;
    }
}